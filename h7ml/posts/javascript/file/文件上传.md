---
icon: javascript
order: 1
date: 2024-09-03
author: h7ml
title: javascript文件上传
description: javascript文件上传
footer: <a href='https://beian.mit.gov.cn/' target='blank'>浙ICP备2021037683号-2</a>javascript文件上传
star: 1
image: https://www.h7ml.cn/logo.png
banner: https://www.h7ml.cn/logo.png
shortTitle: javascript文件上传
category:
  - javascript
tag:
  - javascript
head:
  - - meta
    - name: keywords
      content: javascript文件上传
---

## 交互

### 点击上传多个文件 `multiple`

给`input` 加上`multiple`属性

::: react-demo 点击上传多个文件

```tsx
import React, { useState, useEffect, ChangeEvent } from 'react';

export default () => {
  const [files, setFiles] = useState<File[]>([]);
  const [fileList, setFileList] = useState<string[]>([]);

  const handleChange = (e: ChangeEvent<HTMLInputElement>) => {
    const files = e.target.files;
    if (files) {
      setFiles(Array.from(files));
    }
  };

  useEffect(() => {
    const fileList = files.map((file) => file.name);
    setFileList(fileList);
  }, [files]);

  return (
    <div>
      <input type="file" multiple onChange={handleChange} />
      <ul>
        {fileList.map((file, index) => (
          <li key={index}>{file}</li>
        ))}
      </ul>
    </div>
  );
};
```

:::

### 点击上传文件夹 `odirectory`

::: react-demo 点击上传文件夹

```tsx
import React, { useState, useEffect, ChangeEvent } from 'react';

export default () => {
  const [files, setFiles] = useState<File[]>([]);
  const [fileList, setFileList] = useState<string[]>([]);

  const handleChange = (e: ChangeEvent<HTMLInputElement>) => {
    const files = e.target.files;
    if (files) {
      setFiles(Array.from(files));
    }
  };

  useEffect(() => {
    const fileList = files.map((file) => file.name);
    setFileList(fileList);
  }, [files]);

  return (
    <div>
      <input type="file" webkitdirectory mozdirectory odirectory onChange={handleChange} />
      <ul>
        {fileList.map((file, index) => (
          <li key={index}>{file}</li>
        ))}
      </ul>
    </div>
  );
};
```

:::

### 拖拽上传文件和文件夹`dataTransfer`

::: react-demo 拖拽上传文件和文件夹

```tsx
import React, { useState, useEffect, ChangeEvent, DragEvent } from 'react';

export default () => {
  const [files, setFiles] = useState<File[]>([]);
  const [fileList, setFileList] = useState<string[]>([]);

  const handleChange = (e: ChangeEvent<HTMLInputElement>) => {
    const files = e.target.files;
    if (files) {
      setFiles(Array.from(files));
    }
  };

  const handleDragOver = (e: DragEvent<HTMLInputElement>) => {
    e.preventDefault();
  };

  const handleDrop = (e: DragEvent<HTMLInputElement>) => {
    e.preventDefault();
    const files = e.dataTransfer.items;
    // 判断是否为文件夹
    for (const item of files) {
      const entry = item.webkitGetAsEntry();
      if (entry.isDirectory) {
        console.log('is directory');
        entry.createReader().readEntries((entries) => {
          console.log(entries);
          const fileList = entries.map((entry) => entry.name);
          setFileList(fileList);
        });
      } else {
        console.log('is file');
        entry.file((file) => {
          console.log(file.name);
          setFiles([file]);
        });
      }
    }
  };

  useEffect(() => {
    const fileList = files.map((file) => file.name);
    setFileList(fileList);
  }, [files]);

  return (
    <div>
      <input type="file" multiple onChange={handleChange} onDragOver={handleDragOver} onDrop={handleDrop} />
      <ul>
        {fileList.map((file, index) => (
          <li key={index}>{file}</li>
        ))}
      </ul>
    </div>
  );
};
```

:::

### 如何实现多文件上传

1. 把选择的文件放到一个数组里 `files` 一次性发送到服务器，服务器接收到后，再一次性处理
2. 把选择的文件形成不同的请求，每个请求只处理一个文件一般会选择第二种，第一种方式，如果文件很多，其中一个文件上传失败，需要重新上传所有文件，很难保证对每一个文件的独立控制。第二种方式，需要控制并发数，如果并发数太大，可能会导致服务器崩溃，可以对于每个文件进行单独的控制，比如上传进度，上传取消等。

## 上传进度`progress`

::: react-demo 上传进度

```tsx
import React, { useState } from 'react';
export function App() {
  const [progress, setProgress] = useState(0);

  const handleUpload = (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (file) {
      const xhr = new XMLHttpRequest();
      xhr.open('POST', '/upload');
      xhr.upload.onprogress = (event) => {
        if (event.lengthComputable) {
          const percentComplete = Math.round((event.loaded / event.total) * 100);
          setProgress(percentComplete);
        }
      };
      xhr.send(file);
    }
  };

  return (
    <div>
      <input type="file" onChange={handleUpload} />
      <p>{progress}%</p>
    </div>
  );
}
```

:::

### 如何实现上传进度追踪

::: react-demo 上传进度追踪

```tsx
import React, { useState } from 'react';
export function App() {
  const [progress, setProgress] = useState(0);
  const [xhr, setXhr] = useState<XMLHttpRequest | null>(null);

  const handleUpload = (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (file) {
      const xhr = new XMLHttpRequest();
      xhr.open('POST', '/upload');
      xhr.upload.onprogress = (event) => {
        if (event.lengthComputable) {
          const percentComplete = Math.round((event.loaded / event.total) * 100);
          setProgress(percentComplete);
        }
      };
      xhr.send(file);
      setXhr(xhr);
    }
  };

  const handleCancel = () => {
    if (xhr) {
      xhr.abort();
      setXhr(null);
      setProgress(0);
    }
  };

  return (
    <div>
      <input type="file" onChange={handleUpload} />
      <p>{progress}%</p>
      {xhr && <button onClick={handleCancel}>Cancel</button>}
    </div>
  );
}
```

:::
