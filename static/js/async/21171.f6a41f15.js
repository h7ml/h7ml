/*! For license information please see 21171.f6a41f15.js.LICENSE.txt */
(self.webpackChunkh7ml=self.webpackChunkh7ml||[]).push([["21171"],{85348:function(e,n,t){"use strict";t.r(n);var r=t("52676"),s=t("40453");function i(e){let n=Object.assign({h2:"h2",a:"a",h3:"h3",p:"p",code:"code",img:"img",pre:"pre",ol:"ol",li:"li",ul:"ul",h4:"h4",blockquote:"blockquote"},(0,s.ah)(),e.components);return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)(n.h2,{id:"react-\u5408\u6210\u4E8B\u4EF6",children:["React \u5408\u6210\u4E8B\u4EF6",(0,r.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#react-\u5408\u6210\u4E8B\u4EF6",children:"#"})]}),"\n",(0,r.jsxs)(n.h3,{id:"\u6982\u89C8",children:["\u6982\u89C8",(0,r.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#\u6982\u89C8",children:"#"})]}),"\n",(0,r.jsxs)(n.p,{children:["\u4ECE",(0,r.jsx)(n.code,{children:"v17.0.0"}),"\u5F00\u59CB, React \u4E0D\u4F1A\u518D\u5C06\u4E8B\u4EF6\u5904\u7406\u6DFB\u52A0\u5230 ",(0,r.jsx)(n.code,{children:"document"})," \u4E0A, \u800C\u662F\u5C06\u4E8B\u4EF6\u5904\u7406\u6DFB\u52A0\u5230\u6E32\u67D3 React \u6811\u7684\u6839 DOM \u5BB9\u5668\u4E2D."]}),"\n",(0,r.jsx)(n.p,{children:"\u5F15\u5165\u5B98\u65B9\u63D0\u4F9B\u7684\u56FE\u7247:"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{src:"https://zh-hans.reactjs.org/static/bb4b10114882a50090b8ff61b3c4d0fd/1e088/react_17_delegation.png",alt:""})}),"\n",(0,r.jsxs)(n.p,{children:["\u56FE\u4E2D\u6E05\u6670\u7684\u5C55\u793A\u4E86",(0,r.jsx)(n.code,{children:"v17.0.0"}),"\u7684\u6539\u52A8, \u65E0\u8BBA\u662F\u5728",(0,r.jsx)(n.code,{children:"document"}),"\u8FD8\u662F",(0,r.jsx)(n.code,{children:"\u6839 DOM \u5BB9\u5668"}),"\u4E0A\u76D1\u542C\u4E8B\u4EF6, \u90FD\u53EF\u4EE5\u5F52\u4E3A",(0,r.jsx)(n.code,{children:"\u4E8B\u4EF6\u59D4\u6258(\u4EE3\u7406)"}),"(",(0,r.jsx)(n.a,{href:"https://developer.mozilla.org/zh-CN/docs/Learn/JavaScript/Building_blocks/Events",target:"_blank",rel:"noopener noreferrer",children:"mdn"}),")."]}),"\n",(0,r.jsxs)(n.p,{children:["\u6CE8\u610F: ",(0,r.jsx)(n.code,{children:"react"}),"\u7684\u4E8B\u4EF6\u4F53\u7CFB, \u4E0D\u662F\u5168\u90E8\u90FD\u901A\u8FC7",(0,r.jsx)(n.code,{children:"\u4E8B\u4EF6\u59D4\u6258"}),"\u6765\u5B9E\u73B0\u7684. \u6709\u4E00\u4E9B",(0,r.jsx)(n.a,{href:"https://github.com/facebook/react/blob/v17.0.2/packages/react-dom/src/client/ReactDOMComponent.js#L530-L616",target:"_blank",rel:"noopener noreferrer",children:"\u7279\u6B8A\u60C5\u51B5"}),", \u662F\u76F4\u63A5\u7ED1\u5B9A\u5230\u5BF9\u5E94 DOM \u5143\u7D20\u4E0A\u7684(\u5982:",(0,r.jsx)(n.code,{children:"scroll"}),", ",(0,r.jsx)(n.code,{children:"load"}),"), \u5B83\u4EEC\u90FD\u901A\u8FC7",(0,r.jsx)(n.a,{href:"https://github.com/facebook/react/blob/v17.0.2/packages/react-dom/src/events/DOMPluginEventSystem.js#L295-L314",target:"_blank",rel:"noopener noreferrer",children:"listenToNonDelegatedEvent"}),"\u51FD\u6570\u8FDB\u884C\u7ED1\u5B9A."]}),"\n",(0,r.jsx)(n.p,{children:"\u4E0A\u8FF0\u7279\u6B8A\u4E8B\u4EF6\u6700\u5927\u7684\u4E0D\u540C\u662F\u76D1\u542C\u7684 DOM \u5143\u7D20\u4E0D\u540C, \u9664\u6B64\u4E4B\u5916, \u5176\u4ED6\u5730\u65B9\u7684\u5B9E\u73B0\u4E0E\u6B63\u5E38\u4E8B\u4EF6\u5927\u4F53\u4E00\u81F4."}),"\n",(0,r.jsxs)(n.p,{children:["\u672C\u8282\u8BA8\u8BBA\u7684\u662F\u53EF\u4EE5\u88AB",(0,r.jsx)(n.code,{children:"\u6839 DOM \u5BB9\u5668"}),"\u4EE3\u7406\u7684\u6B63\u5E38\u4E8B\u4EF6."]}),"\n",(0,r.jsxs)(n.h3,{id:"\u4E8B\u4EF6\u7ED1\u5B9A",children:["\u4E8B\u4EF6\u7ED1\u5B9A",(0,r.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#\u4E8B\u4EF6\u7ED1\u5B9A",children:"#"})]}),"\n",(0,r.jsxs)(n.p,{children:["\u5728\u524D\u6587 React \u5E94\u7528\u7684\u542F\u52A8\u8FC7\u7A0B\u4E2D\u4ECB\u7ECD\u4E86",(0,r.jsx)(n.code,{children:"React"}),"\u5728\u542F\u52A8\u65F6\u4F1A\u521B\u5EFA\u5168\u5C40\u5BF9\u8C61, \u5176\u4E2D\u5728\u521B\u5EFA fiberRoot \u5BF9\u8C61\u65F6, \u8C03\u7528",(0,r.jsx)(n.a,{href:"https://github.com/facebook/react/blob/v17.0.2/packages/react-dom/src/client/ReactDOMRoot.js#L120-L169",target:"_blank",rel:"noopener noreferrer",children:"createRootImpl"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-js",children:"function createRootImpl(container: Container, tag: RootTag, options: void | RootOptions) {\n  // ... \u7701\u7565\u65E0\u5173\u4EE3\u7801\n  if (enableEagerRootListeners) {\n    const rootContainerElement = container.nodeType === COMMENT_NODE ? container.parentNode : container;\n    listenToAllSupportedEvents(rootContainerElement);\n  }\n  // ... \u7701\u7565\u65E0\u5173\u4EE3\u7801\n}\n"})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.a,{href:"https://github.com/facebook/react/blob/v17.0.2/packages/react-dom/src/events/DOMPluginEventSystem.js#L316-L349",target:"_blank",rel:"noopener noreferrer",children:"listenToAllSupportedEvents"}),"\u51FD\u6570, \u5B9E\u9645\u4E0A\u5B8C\u6210\u4E86\u4E8B\u4EF6\u4EE3\u7406:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-js",children:"// ... \u7701\u7565\u65E0\u5173\u4EE3\u7801\nexport function listenToAllSupportedEvents(rootContainerElement: EventTarget) {\n  if (enableEagerRootListeners) {\n    // 1. \u8282\u6D41\u4F18\u5316, \u4FDD\u8BC1\u5168\u5C40\u6CE8\u518C\u53EA\u88AB\u8C03\u7528\u4E00\u6B21\n    if ((rootContainerElement: any)[listeningMarker]) {\n      return;\n    }\n    (rootContainerElement: any)[listeningMarker] = true;\n    // 2. \u904D\u5386allNativeEvents \u76D1\u542C\u5192\u6CE1\u548C\u6355\u83B7\u9636\u6BB5\u7684\u4E8B\u4EF6\n    allNativeEvents.forEach((domEventName) => {\n      if (!nonDelegatedEvents.has(domEventName)) {\n        listenToNativeEvent(\n          domEventName,\n          false, // \u5192\u6CE1\u9636\u6BB5\u76D1\u542C\n          ((rootContainerElement: any): Element),\n          null\n        );\n      }\n      listenToNativeEvent(\n        domEventName,\n        true, // \u6355\u83B7\u9636\u6BB5\u76D1\u542C\n        ((rootContainerElement: any): Element),\n        null\n      );\n    });\n  }\n}\n"})}),"\n",(0,r.jsx)(n.p,{children:"\u6838\u5FC3\u903B\u8F91:"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsx)(n.li,{children:"\u8282\u6D41\u4F18\u5316, \u4FDD\u8BC1\u5168\u5C40\u6CE8\u518C\u53EA\u88AB\u8C03\u7528\u4E00\u6B21."}),"\n",(0,r.jsxs)(n.li,{children:["\u904D\u5386",(0,r.jsx)(n.code,{children:"allNativeEvents"}),", \u8C03\u7528",(0,r.jsx)(n.code,{children:"listenToNativeEvent"}),"\u76D1\u542C\u5192\u6CE1\u548C\u6355\u83B7\u9636\u6BB5\u7684\u4E8B\u4EF6.","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"allNativeEvents"}),"\u5305\u62EC\u4E86\u5927\u91CF\u7684\u539F\u751F\u4E8B\u4EF6\u540D\u79F0, \u5B83\u662F\u5728",(0,r.jsx)(n.code,{children:"DOMPluginEventSystem.js"}),"\u4E2D",(0,r.jsx)(n.a,{href:"https://github.com/facebook/react/blob/v17.0.2/packages/react-dom/src/events/DOMPluginEventSystem.js#L89-L93",target:"_blank",rel:"noopener noreferrer",children:"\u88AB\u521D\u59CB\u5316"})]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.a,{href:"https://github.com/facebook/react/blob/v17.0.2/packages/react-dom/src/events/DOMPluginEventSystem.js#L351-L412",target:"_blank",rel:"noopener noreferrer",children:"listenToNativeEvent"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-js",children:"// ... \u7701\u7565\u65E0\u5173\u4EE3\u7801\nexport function listenToNativeEvent(\n  domEventName: DOMEventName,\n  isCapturePhaseListener: boolean,\n  rootContainerElement: EventTarget,\n  targetElement: Element | null,\n  eventSystemFlags?: EventSystemFlags = 0\n): void {\n  let target = rootContainerElement;\n\n  const listenerSet = getEventListenerSet(target);\n  const listenerSetKey = getListenerSetKey(domEventName, isCapturePhaseListener);\n  // \u5229\u7528set\u6570\u636E\u7ED3\u6784, \u4FDD\u8BC1\u76F8\u540C\u7684\u4E8B\u4EF6\u7C7B\u578B\u53EA\u4F1A\u88AB\u6CE8\u518C\u4E00\u6B21.\n  if (!listenerSet.has(listenerSetKey)) {\n    if (isCapturePhaseListener) {\n      eventSystemFlags |= IS_CAPTURE_PHASE;\n    }\n    // \u6CE8\u518C\u4E8B\u4EF6\u76D1\u542C\n    addTrappedEventListener(target, domEventName, eventSystemFlags, isCapturePhaseListener);\n    listenerSet.add(listenerSetKey);\n  }\n}\n"})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.a,{href:"https://github.com/facebook/react/blob/v17.0.2/packages/react-dom/src/events/DOMPluginEventSystem.js#L468-L560",target:"_blank",rel:"noopener noreferrer",children:"addTrappedEventListener"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-js",children:"// ... \u7701\u7565\u65E0\u5173\u4EE3\u7801\nfunction addTrappedEventListener(\n  targetContainer: EventTarget,\n  domEventName: DOMEventName,\n  eventSystemFlags: EventSystemFlags,\n  isCapturePhaseListener: boolean,\n  isDeferredListenerForLegacyFBSupport?: boolean\n) {\n  // 1. \u6784\u9020listener\n  let listener = createEventListenerWrapperWithPriority(targetContainer, domEventName, eventSystemFlags);\n  let unsubscribeListener;\n  // 2. \u6CE8\u518C\u4E8B\u4EF6\u76D1\u542C\n  if (isCapturePhaseListener) {\n    unsubscribeListener = addEventCaptureListener(targetContainer, domEventName, listener);\n  } else {\n    unsubscribeListener = addEventBubbleListener(targetContainer, domEventName, listener);\n  }\n}\n\n// \u6CE8\u518C\u539F\u751F\u4E8B\u4EF6 \u5192\u6CE1\nexport function addEventBubbleListener(target: EventTarget, eventType: string, listener: Function): Function {\n  target.addEventListener(eventType, listener, false);\n  return listener;\n}\n\n// \u6CE8\u518C\u539F\u751F\u4E8B\u4EF6 \u6355\u83B7\nexport function addEventCaptureListener(target: EventTarget, eventType: string, listener: Function): Function {\n  target.addEventListener(eventType, listener, true);\n  return listener;\n}\n"})}),"\n",(0,r.jsxs)(n.p,{children:["\u4ECE",(0,r.jsx)(n.code,{children:"listenToAllSupportedEvents"}),"\u5F00\u59CB, \u8C03\u7528\u94FE\u8DEF\u6BD4\u8F83\u957F, \u6700\u540E\u8C03\u7528",(0,r.jsx)(n.code,{children:"addEventBubbleListener"}),"\u548C",(0,r.jsx)(n.code,{children:"addEventCaptureListener"}),"\u76D1\u542C\u4E86\u539F\u751F\u4E8B\u4EF6."]}),"\n",(0,r.jsxs)(n.h4,{id:"\u539F\u751F-listener",children:["\u539F\u751F listener",(0,r.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#\u539F\u751F-listener",children:"#"})]}),"\n",(0,r.jsxs)(n.p,{children:["\u5728\u6CE8\u518C\u539F\u751F\u4E8B\u4EF6\u7684\u8FC7\u7A0B\u4E2D, \u9700\u8981\u91CD\u70B9\u5173\u6CE8\u4E00\u4E0B\u76D1\u542C\u51FD\u6570, \u5373",(0,r.jsx)(n.code,{children:"listener"}),"\u51FD\u6570. \u5B83\u5B9E\u73B0\u4E86\u628A\u539F\u751F\u4E8B\u4EF6\u6D3E\u53D1\u5230",(0,r.jsx)(n.code,{children:"react"}),"\u4F53\u7CFB\u4E4B\u5185, \u975E\u5E38\u5173\u952E."]}),"\n",(0,r.jsxs)(n.blockquote,{children:["\n",(0,r.jsxs)(n.p,{children:["\u6BD4\u5982\u70B9\u51FB DOM \u89E6\u53D1\u539F\u751F\u4E8B\u4EF6, \u539F\u751F\u4E8B\u4EF6\u6700\u540E\u4F1A\u88AB\u6D3E\u53D1\u5230",(0,r.jsx)(n.code,{children:"react"}),"\u5185\u90E8\u7684",(0,r.jsx)(n.code,{children:"onClick"}),"\u51FD\u6570. ",(0,r.jsx)(n.code,{children:"listener"}),"\u51FD\u6570\u5C31\u662F\u8FD9\u4E2A",(0,r.jsx)(n.code,{children:"\u7531\u5916\u81F3\u5185"}),"\u7684\u5173\u952E\u73AF\u8282."]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"listener"}),"\u662F\u901A\u8FC7",(0,r.jsx)(n.code,{children:"createEventListenerWrapperWithPriority"}),"\u51FD\u6570\u4EA7\u751F:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-js",children:"export function createEventListenerWrapperWithPriority(\n  targetContainer: EventTarget,\n  domEventName: DOMEventName,\n  eventSystemFlags: EventSystemFlags\n): Function {\n  // 1. \u6839\u636E\u4F18\u5148\u7EA7\u8BBE\u7F6E listenerWrapper\n  const eventPriority = getEventPriorityForPluginSystem(domEventName);\n  let listenerWrapper;\n  switch (eventPriority) {\n    case DiscreteEvent:\n      listenerWrapper = dispatchDiscreteEvent;\n      break;\n    case UserBlockingEvent:\n      listenerWrapper = dispatchUserBlockingUpdate;\n      break;\n    case ContinuousEvent:\n    default:\n      listenerWrapper = dispatchEvent;\n      break;\n  }\n  // 2. \u8FD4\u56DE listenerWrapper\n  return listenerWrapper.bind(null, domEventName, eventSystemFlags, targetContainer);\n}\n"})}),"\n",(0,r.jsxs)(n.p,{children:["\u53EF\u4EE5\u770B\u5230, \u4E0D\u540C\u7684",(0,r.jsx)(n.code,{children:"domEventName"}),"\u8C03\u7528",(0,r.jsx)(n.code,{children:"getEventPriorityForPluginSystem"}),"\u540E\u8FD4\u56DE\u4E0D\u540C\u7684\u4F18\u5148\u7EA7, \u6700\u7EC8\u4F1A\u6709 3 \u79CD\u60C5\u51B5:"]}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"DiscreteEvent"}),": \u4F18\u5148\u7EA7\u6700\u9AD8, \u5305\u62EC",(0,r.jsx)(n.code,{children:"click, keyDown, input"}),"\u7B49\u4E8B\u4EF6, ",(0,r.jsx)(n.a,{href:"https://github.com/facebook/react/blob/v17.0.2/packages/react-dom/src/events/DOMEventProperties.js#L45-L80",target:"_blank",rel:"noopener noreferrer",children:"\u6E90\u7801"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\u5BF9\u5E94\u7684",(0,r.jsx)(n.code,{children:"listener"}),"\u662F",(0,r.jsx)(n.a,{href:"https://github.com/facebook/react/blob/v17.0.2/packages/react-dom/src/events/ReactDOMEventListener.js#L121-L142",target:"_blank",rel:"noopener noreferrer",children:"dispatchDiscreteEvent"})]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"UserBlockingEvent"}),": \u4F18\u5148\u7EA7\u9002\u4E2D, \u5305\u62EC",(0,r.jsx)(n.code,{children:"drag, scroll"}),"\u7B49\u4E8B\u4EF6, ",(0,r.jsx)(n.a,{href:"https://github.com/facebook/react/blob/v17.0.2/packages/react-dom/src/events/DOMEventProperties.js#L100-L116",target:"_blank",rel:"noopener noreferrer",children:"\u6E90\u7801"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\u5BF9\u5E94\u7684",(0,r.jsx)(n.code,{children:"listener"}),"\u662F",(0,r.jsx)(n.a,{href:"https://github.com/facebook/react/blob/v17.0.2/packages/react-dom/src/events/ReactDOMEventListener.js#L144-L180",target:"_blank",rel:"noopener noreferrer",children:"dispatchUserBlockingUpdate"})]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"ContinuousEvent"}),": \u4F18\u5148\u7EA7\u6700\u4F4E,\u5305\u62EC",(0,r.jsx)(n.code,{children:"animation, load"}),"\u7B49\u4E8B\u4EF6, ",(0,r.jsx)(n.a,{href:"https://github.com/facebook/react/blob/v17.0.2/packages/react-dom/src/events/DOMEventProperties.js#L119-L145",target:"_blank",rel:"noopener noreferrer",children:"\u6E90\u7801"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\u5BF9\u5E94\u7684",(0,r.jsx)(n.code,{children:"listener"}),"\u662F",(0,r.jsx)(n.a,{href:"https://github.com/facebook/react/blob/v17.0.2/packages/react-dom/src/events/ReactDOMEventListener.js#L182-L271",target:"_blank",rel:"noopener noreferrer",children:"dispatchEvent"})]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["\u8FD9 3 \u79CD",(0,r.jsx)(n.code,{children:"listener"}),"\u5B9E\u9645\u4E0A\u90FD\u662F\u5BF9",(0,r.jsx)(n.a,{href:"https://github.com/facebook/react/blob/v17.0.2/packages/react-dom/src/events/ReactDOMEventListener.js#L182-L271",target:"_blank",rel:"noopener noreferrer",children:"dispatchEvent"}),"\u7684\u5305\u88C5:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-js",children:"// ...\u7701\u7565\u65E0\u5173\u4EE3\u7801\nexport function dispatchEvent(\n  domEventName: DOMEventName,\n  eventSystemFlags: EventSystemFlags,\n  targetContainer: EventTarget,\n  nativeEvent: AnyNativeEvent\n): void {\n  if (!_enabled) {\n    return;\n  }\n  const blockedOn = attemptToDispatchEvent(domEventName, eventSystemFlags, targetContainer, nativeEvent);\n}\n"})}),"\n",(0,r.jsxs)(n.h3,{id:"\u4E8B\u4EF6\u89E6\u53D1",children:["\u4E8B\u4EF6\u89E6\u53D1",(0,r.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#\u4E8B\u4EF6\u89E6\u53D1",children:"#"})]}),"\n",(0,r.jsxs)(n.p,{children:["\u5F53\u539F\u751F\u4E8B\u4EF6\u89E6\u53D1\u4E4B\u540E, \u9996\u5148\u4F1A\u8FDB\u5165\u5230",(0,r.jsx)(n.code,{children:"dispatchEvent"}),"\u8FD9\u4E2A\u56DE\u8C03\u51FD\u6570. \u800C",(0,r.jsx)(n.code,{children:"dispatchEvent"}),"\u51FD\u6570\u662F",(0,r.jsx)(n.code,{children:"react"}),"\u4E8B\u4EF6\u4F53\u7CFB\u4E2D\u6700\u5173\u952E\u7684\u51FD\u6570, \u5176\u8C03\u7528\u94FE\u8DEF\u8F83\u957F, \u6838\u5FC3\u6B65\u9AA4\u5982\u56FE\u6240\u793A:"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.img,{src:"https://7kms.github.io/react-illustration-series/static/dispatch-event.4c0afc05.png",alt:""})," \u91CD\u70B9\u5173\u6CE8\u5176\u4E2D 3 \u4E2A\u6838\u5FC3\u73AF\u8282:"]}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"attemptToDispatchEvent"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"SimpleEventPlugin.extractEvents"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"processDispatchQueue"})}),"\n"]}),"\n",(0,r.jsxs)(n.h4,{id:"\u5173\u8054-fiber",children:["\u5173\u8054 fiber",(0,r.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#\u5173\u8054-fiber",children:"#"})]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.a,{href:"https://github.com/facebook/react/blob/v17.0.2/packages/react-dom/src/events/ReactDOMEventListener.js#L274-L331",target:"_blank",rel:"noopener noreferrer",children:"attemptToDispatchEvent"}),"\u628A\u539F\u751F\u4E8B\u4EF6\u548C",(0,r.jsx)(n.code,{children:"fiber\u6811"}),"\u5173\u8054\u8D77\u6765."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-js",children:"export function attemptToDispatchEvent(\n  domEventName: DOMEventName,\n  eventSystemFlags: EventSystemFlags,\n  targetContainer: EventTarget,\n  nativeEvent: AnyNativeEvent\n): null | Container | SuspenseInstance {\n  // ...\u7701\u7565\u65E0\u5173\u4EE3\u7801\n\n  // 1. \u5B9A\u4F4D\u539F\u751FDOM\u8282\u70B9\n  const nativeEventTarget = getEventTarget(nativeEvent);\n  // 2. \u83B7\u53D6\u4E0EDOM\u8282\u70B9\u5BF9\u5E94\u7684fiber\u8282\u70B9\n  let targetInst = getClosestInstanceFromNode(nativeEventTarget);\n  // 3. \u901A\u8FC7\u63D2\u4EF6\u7CFB\u7EDF, \u6D3E\u53D1\u4E8B\u4EF6\n  dispatchEventForPluginEventSystem(domEventName, eventSystemFlags, nativeEvent, targetInst, targetContainer);\n  return null;\n}\n"})}),"\n",(0,r.jsx)(n.p,{children:"\u6838\u5FC3\u903B\u8F91:"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["\u5B9A\u4F4D\u539F\u751F DOM \u8282\u70B9: \u8C03\u7528",(0,r.jsx)(n.code,{children:"getEventTarget"})]}),"\n",(0,r.jsxs)(n.li,{children:["\u83B7\u53D6\u4E0E DOM \u8282\u70B9\u5BF9\u5E94\u7684 fiber \u8282\u70B9: \u8C03\u7528",(0,r.jsx)(n.code,{children:"getClosestInstanceFromNode"})]}),"\n",(0,r.jsxs)(n.li,{children:["\u901A\u8FC7\u63D2\u4EF6\u7CFB\u7EDF, \u6D3E\u53D1\u4E8B\u4EF6: \u8C03\u7528 ",(0,r.jsx)(n.code,{children:"dispatchEventForPluginEventSystem"})]}),"\n"]}),"\n",(0,r.jsxs)(n.h4,{id:"\u6536\u96C6-fiber-\u4E0A\u7684-listener",children:["\u6536\u96C6 fiber \u4E0A\u7684 listener",(0,r.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#\u6536\u96C6-fiber-\u4E0A\u7684-listener",children:"#"})]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"dispatchEvent"}),"\u51FD\u6570\u7684\u8C03\u7528\u94FE\u8DEF\u4E2D, \u901A\u8FC7\u4E0D\u540C\u7684\u63D2\u4EF6, \u5904\u7406\u4E0D\u540C\u7684\u4E8B\u4EF6. \u5176\u4E2D\u6700\u5E38\u89C1\u7684\u4E8B\u4EF6\u90FD\u4F1A\u7531",(0,r.jsx)(n.code,{children:"SimpleEventPlugin.extractEvents"}),"\u8FDB\u884C\u5904\u7406:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-js",children:"function extractEvents(\n  dispatchQueue: DispatchQueue,\n  domEventName: DOMEventName,\n  targetInst: null | Fiber,\n  nativeEvent: AnyNativeEvent,\n  nativeEventTarget: null | EventTarget,\n  eventSystemFlags: EventSystemFlags,\n  targetContainer: EventTarget\n): void {\n  const reactName = topLevelEventsToReactNames.get(domEventName);\n  if (reactName === undefined) {\n    return;\n  }\n  let SyntheticEventCtor = SyntheticEvent;\n  let reactEventType: string = domEventName;\n\n  const inCapturePhase = (eventSystemFlags & IS_CAPTURE_PHASE) !== 0;\n  const accumulateTargetOnly = !inCapturePhase && domEventName === 'scroll';\n  // 1. \u6536\u96C6\u6240\u6709\u76D1\u542C\u8BE5\u4E8B\u4EF6\u7684\u51FD\u6570.\n  const listeners = accumulateSinglePhaseListeners(\n    targetInst,\n    reactName,\n    nativeEvent.type,\n    inCapturePhase,\n    accumulateTargetOnly\n  );\n  if (listeners.length > 0) {\n    // 2. \u6784\u9020\u5408\u6210\u4E8B\u4EF6, \u6DFB\u52A0\u5230\u6D3E\u53D1\u961F\u5217\n    const event = new SyntheticEventCtor(reactName, reactEventType, null, nativeEvent, nativeEventTarget);\n    dispatchQueue.push({ event, listeners });\n  }\n}\n"})}),"\n",(0,r.jsx)(n.p,{children:"\u6838\u5FC3\u903B\u8F91:"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:["\u6536\u96C6\u6240\u6709",(0,r.jsx)(n.code,{children:"listener"}),"\u56DE\u8C03"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:["\u8FD9\u91CC\u7684\u662F",(0,r.jsx)(n.code,{children:"fiber.memoizedProps.onClick/onClickCapture"}),"\u7B49\u7ED1\u5B9A\u5728",(0,r.jsx)(n.code,{children:"fiber"}),"\u8282\u70B9\u4E0A\u7684\u56DE\u8C03\u51FD\u6570"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:["\u5177\u4F53\u903B\u8F91\u5728",(0,r.jsx)(n.a,{href:"https://github.com/facebook/react/blob/v17.0.2/packages/react-dom/src/events/DOMPluginEventSystem.js#L712-L803",target:"_blank",rel:"noopener noreferrer",children:"accumulateSinglePhaseListeners"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-js",children:"export function accumulateSinglePhaseListeners(\n  targetFiber: Fiber | null,\n  reactName: string | null,\n  nativeEventType: string,\n  inCapturePhase: boolean,\n  accumulateTargetOnly: boolean\n): Array<DispatchListener> {\n  const captureName = reactName !== null ? reactName + 'Capture' : null;\n  const reactEventName = inCapturePhase ? captureName : reactName;\n  const listeners: Array<DispatchListener> = [];\n\n  let instance = targetFiber;\n  let lastHostComponent = null;\n\n  // \u4ECEtargetFiber\u5F00\u59CB, \u5411\u4E0A\u904D\u5386, \u76F4\u5230 root \u4E3A\u6B62\n  while (instance !== null) {\n    const { stateNode, tag } = instance;\n    // \u5F53\u8282\u70B9\u7C7B\u578B\u662FHostComponent\u65F6(\u5982: div, span, button\u7B49\u7C7B\u578B)\n    if (tag === HostComponent && stateNode !== null) {\n      lastHostComponent = stateNode;\n      if (reactEventName !== null) {\n        // \u83B7\u53D6\u6807\u51C6\u7684\u76D1\u542C\u51FD\u6570 (\u5982onClick , onClickCapture\u7B49)\n        const listener = getListener(instance, reactEventName);\n        if (listener != null) {\n          listeners.push(createDispatchListener(instance, listener, lastHostComponent));\n        }\n      }\n    }\n    // \u5982\u679C\u53EA\u6536\u96C6\u76EE\u6807\u8282\u70B9, \u5219\u4E0D\u7528\u5411\u4E0A\u904D\u5386, \u76F4\u63A5\u9000\u51FA\n    if (accumulateTargetOnly) {\n      break;\n    }\n    instance = instance.return;\n  }\n  return listeners;\n}\n"})}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:["\u6784\u9020\u5408\u6210\u4E8B\u4EF6(",(0,r.jsx)(n.code,{children:"SyntheticEvent"}),"), \u6DFB\u52A0\u5230\u6D3E\u53D1\u961F\u5217(",(0,r.jsx)(n.code,{children:"dispatchQueue"}),")"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.h4,{id:"\u6784\u9020\u5408\u6210\u4E8B\u4EF6",children:["\u6784\u9020\u5408\u6210\u4E8B\u4EF6",(0,r.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#\u6784\u9020\u5408\u6210\u4E8B\u4EF6",children:"#"})]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.a,{href:"https://github.com/facebook/react/blob/v17.0.2/packages/react-dom/src/events/SyntheticEvent.js#L152",target:"_blank",rel:"noopener noreferrer",children:"SyntheticEvent"}),", \u662F",(0,r.jsx)(n.code,{children:"react"}),"\u5185\u90E8\u521B\u5EFA\u7684\u4E00\u4E2A\u5BF9\u8C61, \u662F\u539F\u751F\u4E8B\u4EF6\u7684\u8DE8\u6D4F\u89C8\u5668\u5305\u88C5\u5668, \u62E5\u6709\u548C\u6D4F\u89C8\u5668\u539F\u751F\u4E8B\u4EF6\u76F8\u540C\u7684\u63A5\u53E3(",(0,r.jsx)(n.code,{children:"stopPropagation"}),",",(0,r.jsx)(n.code,{children:"preventDefault"}),"), \u62B9\u5E73\u4E0D\u540C\u6D4F\u89C8\u5668 api \u7684\u5DEE\u5F02, \u517C\u5BB9\u6027\u597D."]}),"\n",(0,r.jsxs)(n.p,{children:["\u5177\u4F53\u7684\u6784\u9020\u8FC7\u7A0B\u5E76\u4E0D\u590D\u6742, \u53EF\u4EE5\u76F4\u63A5",(0,r.jsx)(n.a,{href:"https://github.com/facebook/react/blob/v17.0.2/packages/react-dom/src/events/SyntheticEvent.js#L28-L136",target:"_blank",rel:"noopener noreferrer",children:"\u67E5\u770B\u6E90\u7801"}),"."]}),"\n",(0,r.jsxs)(n.p,{children:["\u6B64\u5904\u6211\u4EEC\u9700\u8981\u77E5\u9053, \u5728",(0,r.jsx)(n.code,{children:"Plugin.extractEvents"}),"\u8FC7\u7A0B\u4E2D, \u904D\u5386",(0,r.jsx)(n.code,{children:"fiber\u6811"}),"\u627E\u5230",(0,r.jsx)(n.code,{children:"listener"}),"\u4E4B\u540E, \u5C31\u4F1A\u521B\u5EFA",(0,r.jsx)(n.code,{children:"SyntheticEvent"}),", \u52A0\u5165\u5230",(0,r.jsx)(n.code,{children:"dispatchQueue"}),"\u4E2D, \u7B49\u5F85\u6D3E\u53D1."]}),"\n",(0,r.jsxs)(n.h4,{id:"\u6267\u884C\u6D3E\u53D1",children:["\u6267\u884C\u6D3E\u53D1",(0,r.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#\u6267\u884C\u6D3E\u53D1",children:"#"})]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"extractEvents"}),"\u5B8C\u6210\u4E4B\u540E, \u903B\u8F91\u6765\u5230",(0,r.jsx)(n.a,{href:"https://github.com/facebook/react/blob/v17.0.2/packages/react-dom/src/events/DOMPluginEventSystem.js#L260-L272",target:"_blank",rel:"noopener noreferrer",children:"processDispatchQueue"}),", \u7EC8\u4E8E\u8981\u771F\u6B63\u6267\u884C\u6D3E\u53D1\u4E86."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-js",children:"export function processDispatchQueue(dispatchQueue: DispatchQueue, eventSystemFlags: EventSystemFlags): void {\n  const inCapturePhase = (eventSystemFlags & IS_CAPTURE_PHASE) !== 0;\n  for (let i = 0; i < dispatchQueue.length; i++) {\n    const { event, listeners } = dispatchQueue[i];\n    processDispatchQueueItemsInOrder(event, listeners, inCapturePhase);\n  }\n  // ...\u7701\u7565\u65E0\u5173\u4EE3\u7801\n}\n\nfunction processDispatchQueueItemsInOrder(\n  event: ReactSyntheticEvent,\n  dispatchListeners: Array<DispatchListener>,\n  inCapturePhase: boolean\n): void {\n  let previousInstance;\n  if (inCapturePhase) {\n    // 1. capture\u4E8B\u4EF6: \u5012\u5E8F\u904D\u5386listeners\n    for (let i = dispatchListeners.length - 1; i >= 0; i--) {\n      const { instance, currentTarget, listener } = dispatchListeners[i];\n      if (instance !== previousInstance && event.isPropagationStopped()) {\n        return;\n      }\n      executeDispatch(event, listener, currentTarget);\n      previousInstance = instance;\n    }\n  } else {\n    // 2. bubble\u4E8B\u4EF6: \u987A\u5E8F\u904D\u5386listeners\n    for (let i = 0; i < dispatchListeners.length; i++) {\n      const { instance, currentTarget, listener } = dispatchListeners[i];\n      if (instance !== previousInstance && event.isPropagationStopped()) {\n        return;\n      }\n      executeDispatch(event, listener, currentTarget);\n      previousInstance = instance;\n    }\n  }\n}\n"})}),"\n",(0,r.jsxs)(n.p,{children:["\u5728",(0,r.jsx)(n.a,{href:"https://github.com/facebook/react/blob/v17.0.2/packages/react-dom/src/events/DOMPluginEventSystem.js#L233-L258",target:"_blank",rel:"noopener noreferrer",children:"processDispatchQueueItemsInOrder"}),"\u904D\u5386",(0,r.jsx)(n.code,{children:"dispatchListeners"}),"\u6570\u7EC4, \u6267\u884C",(0,r.jsx)(n.a,{href:"https://github.com/facebook/react/blob/v17.0.2/packages/react-dom/src/events/DOMPluginEventSystem.js#L222-L231",target:"_blank",rel:"noopener noreferrer",children:"executeDispatch"}),"\u6D3E\u53D1\u4E8B\u4EF6, \u5728",(0,r.jsx)(n.code,{children:"fiber"}),"\u8282\u70B9\u4E0A\u7ED1\u5B9A\u7684",(0,r.jsx)(n.code,{children:"listener"}),"\u51FD\u6570\u88AB\u6267\u884C."]}),"\n",(0,r.jsxs)(n.p,{children:["\u5728",(0,r.jsx)(n.code,{children:"processDispatchQueueItemsInOrder"}),"\u51FD\u6570\u4E2D, \u6839\u636E",(0,r.jsx)(n.code,{children:"\u6355\u83B7(capture)"}),"\u6216",(0,r.jsx)(n.code,{children:"\u5192\u6CE1(bubble)"}),"\u7684\u4E0D\u540C, \u91C7\u53D6\u4E86\u4E0D\u540C\u7684\u904D\u5386\u65B9\u5F0F:"]}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"capture"}),"\u4E8B\u4EF6: ",(0,r.jsx)(n.code,{children:"\u4ECE\u4E0A\u81F3\u4E0B"}),"\u8C03\u7528",(0,r.jsx)(n.code,{children:"fiber\u6811"}),"\u4E2D\u7ED1\u5B9A\u7684\u56DE\u8C03\u51FD\u6570, \u6240\u4EE5",(0,r.jsx)(n.code,{children:"\u5012\u5E8F"}),"\u904D\u5386",(0,r.jsx)(n.code,{children:"dispatchListeners"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"bubble"}),"\u4E8B\u4EF6: ",(0,r.jsx)(n.code,{children:"\u4ECE\u4E0B\u81F3\u4E0A"}),"\u8C03\u7528",(0,r.jsx)(n.code,{children:"fiber\u6811"}),"\u4E2D\u7ED1\u5B9A\u7684\u56DE\u8C03\u51FD\u6570, \u6240\u4EE5",(0,r.jsx)(n.code,{children:"\u987A\u5E8F"}),"\u904D\u5386",(0,r.jsx)(n.code,{children:"dispatchListeners"}),"."]}),"\n"]}),"\n",(0,r.jsxs)(n.h3,{id:"\u603B\u7ED3",children:["\u603B\u7ED3",(0,r.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#\u603B\u7ED3",children:"#"})]}),"\n",(0,r.jsxs)(n.p,{children:["\u4ECE\u67B6\u6784\u4E0A\u6765\u8BB2, ",(0,r.jsx)(n.a,{href:"https://github.com/facebook/react/blob/v17.0.2/packages/react-dom/src/events/SyntheticEvent.js#L152",target:"_blank",rel:"noopener noreferrer",children:"SyntheticEvent"}),"\u6253\u901A\u4E86\u4ECE\u5916\u90E8",(0,r.jsx)(n.code,{children:"\u539F\u751F\u4E8B\u4EF6"}),"\u5230\u5185\u90E8",(0,r.jsx)(n.code,{children:"fiber\u6811"}),"\u7684\u4EA4\u4E92\u6E20\u9053, \u4F7F\u5F97",(0,r.jsx)(n.code,{children:"react"}),"\u80FD\u591F\u611F\u77E5\u5230\u6D4F\u89C8\u5668\u63D0\u4F9B\u7684",(0,r.jsx)(n.code,{children:"\u539F\u751F\u4E8B\u4EF6"}),", \u8FDB\u800C\u505A\u51FA\u4E0D\u540C\u7684\u54CD\u5E94, \u4FEE\u6539",(0,r.jsx)(n.code,{children:"fiber\u6811"}),", \u53D8\u66F4\u89C6\u56FE\u7B49."]}),"\n",(0,r.jsx)(n.p,{children:"\u4ECE\u5B9E\u73B0\u4E0A\u8BB2, \u4E3B\u8981\u5206\u4E3A 3 \u6B65:"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["\u76D1\u542C\u539F\u751F\u4E8B\u4EF6: \u5BF9\u9F50",(0,r.jsx)(n.code,{children:"DOM\u5143\u7D20"}),"\u548C",(0,r.jsx)(n.code,{children:"fiber\u5143\u7D20"})]}),"\n",(0,r.jsxs)(n.li,{children:["\u6536\u96C6",(0,r.jsx)(n.code,{children:"listeners"}),": \u904D\u5386",(0,r.jsx)(n.code,{children:"fiber\u6811"}),", \u6536\u96C6\u6240\u6709\u76D1\u542C\u672C\u4E8B\u4EF6\u7684",(0,r.jsx)(n.code,{children:"listener"}),"\u51FD\u6570."]}),"\n",(0,r.jsxs)(n.li,{children:["\u6D3E\u53D1\u5408\u6210\u4E8B\u4EF6: \u6784\u9020\u5408\u6210\u4E8B\u4EF6, \u904D\u5386",(0,r.jsx)(n.code,{children:"listeners"}),"\u8FDB\u884C\u6D3E\u53D1."]}),"\n"]})]})}function c(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{wrapper:n}=Object.assign({},(0,s.ah)(),e.components);return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(i,{...e})}):i(e)}n.default=c,c.__RSPRESS_PAGE_META={},c.__RSPRESS_PAGE_META["posts%2Freact%2Fsynthetic-event.md"]={toc:[{text:"React \u5408\u6210\u4E8B\u4EF6",id:"react-\u5408\u6210\u4E8B\u4EF6",depth:2},{text:"\u6982\u89C8",id:"\u6982\u89C8",depth:3},{text:"\u4E8B\u4EF6\u7ED1\u5B9A",id:"\u4E8B\u4EF6\u7ED1\u5B9A",depth:3},{text:"\u539F\u751F listener",id:"\u539F\u751F-listener",depth:4},{text:"\u4E8B\u4EF6\u89E6\u53D1",id:"\u4E8B\u4EF6\u89E6\u53D1",depth:3},{text:"\u5173\u8054 fiber",id:"\u5173\u8054-fiber",depth:4},{text:"\u6536\u96C6 fiber \u4E0A\u7684 listener",id:"\u6536\u96C6-fiber-\u4E0A\u7684-listener",depth:4},{text:"\u6784\u9020\u5408\u6210\u4E8B\u4EF6",id:"\u6784\u9020\u5408\u6210\u4E8B\u4EF6",depth:4},{text:"\u6267\u884C\u6D3E\u53D1",id:"\u6267\u884C\u6D3E\u53D1",depth:4},{text:"\u603B\u7ED3",id:"\u603B\u7ED3",depth:3}],title:"synthetic-event",frontmatter:{icon:"react",order:2,date:"2021-07-12T00:00:00.000Z",author:"h7ml",title:"synthetic-event",category:"react",tag:["react","synthetic-event"],star:!0,lastUpdated:!1}}}}]);